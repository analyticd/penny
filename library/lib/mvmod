#!/bin/bash

# Renames a module from the name given in $1 to the name given in $2.
# Moves the module to the appropriate new location in the file tree,
# changes the module name in the file itself, and changes all imports
# in the hierarchy.

# Works only with .hs files; does not work with literate Haskell
# files, Alex files, etc.

# Sample usage:
# mvmod Penny.Name.Old Penny.New.Name

# In an attempt to maintain compatibility across UNIX systems, this
# script uses bash rather than sh in the shebang line.  Also, uses ed
# rather than in-place sed, because the behavior of in-place sed
# varies across GNU and BSD systems.  However, the regular expressions
# supported by ed are very basic.

set -e

if [[ $# -ne 2 ]]; then
    echo "mvmod: usage: mvmod old-name new-name" 1>&2
    exit 1
fi

oldFileName="${1//.//}.hs"
newFileName="${2//.//}.hs"
newDirName="$(dirname "$newFileName")"
oldModNameRegex="${1//./\\.}"

mkdir -p "$newDirName"
mv "$oldFileName" "$newFileName"

# change header in moved module
ed -s "$newFileName" <<EOF
%s/^module ${oldModNameRegex}/module $2/
w
q
EOF

for file in $(find . -name '*.hs'); do

# the extra g command in the front suppresses errors if the substitute
# string is not found.

ed -s $file <<EOF
g/./%s/^import ${oldModNameRegex} /import $2 /
g/./%s/^import ${oldModNameRegex}$/import $2/
g/./%s/^import qualified ${oldModNameRegex} /import qualified $2 /
g/./%s/^import qualified ${oldModNameRegex}$/import qualified $2/
w
q
EOF
done
